{{- $image := .Params.image | default "" -}}
{{- if and $image (not (urls.Parse $image).IsAbs) -}}
{{- with .Resources.GetMatch $image -}}
{{- $image = .RelPermalink -}}
{{- end -}}
{{- end -}}

{{- /* Stale Warning Logic */ -}}
{{- $postDate := .Date -}}
{{- $now := now -}}
{{- $diffYears := sub $now.Year $postDate.Year -}}
{{- $isStale := false -}}
{{- if or (gt $diffYears 3) (and (eq $diffYears 3) (or (gt $now.Month $postDate.Month) (and (eq $now.Month
$postDate.Month) (ge $now.Day $postDate.Day)))) -}}
{{- $isStale = true -}}
{{- end -}}

{{- $warningHTML := "" -}}
{{- if $isStale -}}
{{- $warningHTML = `<div class="stale-warning fade-up" style="
    background: #fff8e1;
    color: #5d4037;
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 2.5rem;
    border: 1px solid #ffe082;
    box-shadow: 0 4px 20px rgba(255, 193, 7, 0.1);
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
    line-height: 1.6;
  ">
    <div style="
        background: #ffc107;
        color: #fff;
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    ">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
    </div>
    <div>
        <h4 style="margin: 0 0 0.5rem 0; color: #795548; font-size: 1.1rem; font-weight: 700;">這篇文章很舊了</h4>
        <p style="margin: 0; font-size: 0.95rem; opacity: 0.9;">這篇文章預計發布於三年前（或更久），部分技術細節、軟體版本或 API
            規格可能已經過時或被迭代。請在參考時特別留意相關套件的最新官方文件。</p>
    </div>
</div>` -}}
{{- end -}}

{{- $content := .Content -}}
{{- if $isStale -}}
{{- $content = print $warningHTML $content -}}
{{- end -}}

{{- $data := dict "title" .Title "url" (replace .RelPermalink "index.json" "") "date" (.Date.Format "2006-01-02")
"summary" (.Summary | plainify | replaceRE "\\s+" " ") "tags" (.Params.tags | default slice) "series" (.Params.series |
default slice) "author" (.Params.author | default site.Params.author) "readingTime" .ReadingTime "wordCount" .WordCount
"content" $content "image" $image "is_stale" $isStale "layout_check" "single" -}}
{{- return $data -}}